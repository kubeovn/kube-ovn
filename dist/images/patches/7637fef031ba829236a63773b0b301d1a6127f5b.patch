From 7637fef031ba829236a63773b0b301d1a6127f5b Mon Sep 17 00:00:00 2001
From: clyi <clyi@alauda.io>
Date: Thu, 26 Jun 2025 15:45:37 +0800
Subject: [PATCH] should consider nodelocaldns reply packet skip acl

Signed-off-by: clyi <clyi@alauda.io>
---
 northd/northd.c | 22 ++++++++++++++++++++++
 1 file changed, 22 insertions(+)

diff --git a/northd/northd.c b/northd/northd.c
index f01cfb72e2..732ff8092d 100644
--- a/northd/northd.c
+++ b/northd/northd.c
@@ -6179,11 +6179,21 @@ build_ls_stateful_rec_pre_acls(
         const char **array = sset_array(&node_local_dns_ip_v4);
         for (size_t i = 0; i < sset_count(&node_local_dns_ip_v4); i++) {
             match = xasprintf("ip4 && ip4.dst == %s", array[i]);
+            ovn_lflow_add_with_kube_ovn_hint(lflows, od, S_SWITCH_IN_PRE_ACL,
+                                    110, match, "next;",
+                                    &od->nbs->header_, lflow_ref);
 
+            match = xasprintf("ip4 && ip4.dst == %s", array[i]);
+            ovn_lflow_add_with_kube_ovn_hint(lflows, od, S_SWITCH_OUT_PRE_ACL,
+                                    110, match, "next;",
+                                    &od->nbs->header_, lflow_ref);
+
+            match = xasprintf("ip4 && ip4.src == %s", array[i]);
             ovn_lflow_add_with_kube_ovn_hint(lflows, od, S_SWITCH_IN_PRE_ACL,
                                     110, match, "next;",
                                     &od->nbs->header_, lflow_ref);
 
+            match = xasprintf("ip4 && ip4.src == %s", array[i]);
             ovn_lflow_add_with_kube_ovn_hint(lflows, od, S_SWITCH_OUT_PRE_ACL,
                                     110, match, "next;",
                                     &od->nbs->header_, lflow_ref);
@@ -6197,9 +6207,21 @@ build_ls_stateful_rec_pre_acls(
                                     110, match, "next;",
                                     &od->nbs->header_, lflow_ref);
 
+            match = xasprintf("ip6 && ip6.dst == %s", array[i]);
+            ovn_lflow_add_with_kube_ovn_hint(lflows, od, S_SWITCH_OUT_PRE_ACL,
+                                    110, match, "next;",
+                                    &od->nbs->header_, lflow_ref);
+
+            match = xasprintf("ip6 && ip6.src == %s", array[i]);
+            ovn_lflow_add_with_kube_ovn_hint(lflows, od, S_SWITCH_IN_PRE_ACL,
+                                    110, match, "next;",
+                                    &od->nbs->header_, lflow_ref);
+
+            match = xasprintf("ip6 && ip6.src == %s", array[i]);
             ovn_lflow_add_with_kube_ovn_hint(lflows, od, S_SWITCH_OUT_PRE_ACL,
                                     110, match, "next;",
                                     &od->nbs->header_, lflow_ref);
+
             free(match);
         }
         free(array);
