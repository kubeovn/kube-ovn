From 918d6dc79634bec760054ee53f7628186315bcfb Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?=E5=BC=A0=E7=A5=96=E5=BB=BA?= <zhangzujian.7@gmail.com>
Date: Thu, 25 Aug 2022 16:09:04 +0800
Subject: [PATCH] fix log file descriptor leak in monitor process

---
 include/openvswitch/vlog.h |  1 +
 lib/daemon-unix.c          |  1 +
 lib/vlog.c                 | 18 ++++++++++++++++++
 3 files changed, 20 insertions(+)

diff --git a/include/openvswitch/vlog.h b/include/openvswitch/vlog.h
index 886fce5e0fd..2253502fe2d 100644
--- a/include/openvswitch/vlog.h
+++ b/include/openvswitch/vlog.h
@@ -133,6 +133,7 @@ void vlog_set_verbosity(const char *arg);
 void vlog_set_pattern(enum vlog_destination, const char *pattern);
 int vlog_set_log_file(const char *file_name);
 int vlog_reopen_log_file(void);
+void vlog_close_log_file(void);
 #ifndef _WIN32
 void vlog_change_owner_unix(uid_t, gid_t);
 #endif
diff --git a/lib/daemon-unix.c b/lib/daemon-unix.c
index 34d45b82a1f..604ae5ed9ea 100644
--- a/lib/daemon-unix.c
+++ b/lib/daemon-unix.c
@@ -359,6 +359,7 @@ monitor_daemon(pid_t daemon_pid)
         ovs_cmdl_proctitle_set("monitoring pid %lu (%s)",
                                (unsigned long int) daemon_pid, status_msg);
 
+        vlog_close_log_file();
         if (child_ready) {
             int error;
             do {
diff --git a/lib/vlog.c b/lib/vlog.c
index 533f9375550..8b2e9be34c8 100644
--- a/lib/vlog.c
+++ b/lib/vlog.c
@@ -439,6 +439,24 @@ vlog_reopen_log_file(void)
     }
 }
 
+void
+vlog_close_log_file(void) {
+    ovs_mutex_lock(&log_file_mutex);
+    if (log_fd >= 0) {
+        close(log_fd);
+        log_fd = -1;
+
+        async_append_destroy(log_writer);
+        log_writer = NULL;
+
+        struct vlog_module *mp;
+        LIST_FOR_EACH (mp, list, &vlog_modules) {
+            update_min_level(mp);
+        }
+    }
+    ovs_mutex_unlock(&log_file_mutex);
+}
+
 #ifndef _WIN32
 /* In case a log file exists, change its owner to new 'user' and 'group'.
  *
