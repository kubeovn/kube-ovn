# syntax = docker/dockerfile:experimental
ARG GO_VERSION=1.23.8

FROM ubuntu:22.04 AS ovs-builder

ARG ARCH
ARG DEBIAN_FRONTEND=noninteractive
ARG SRC_DIR='/usr/src'

ADD patches/2dc8e7aa202818952b2fa80b47298604530c9de0.patch $SRC_DIR
ADD patches/918d6dc79634bec760054ee53f7628186315bcfb.patch $SRC_DIR
ADD patches/22ea22c40b46ee5adeae977ff6cfca81b3ff25d7.patch $SRC_DIR
ADD patches/8c2f28b778129161bbf8f0738fa41d385860d5bc.patch $SRC_DIR
ADD patches/1cb138aaf2fdf922d75a587e4e9cf610d38f9fee.patch $SRC_DIR
ADD patches/2e2ec1161cadbec79786d63fde9475053d996586.patch $SRC_DIR
ADD patches/62d4969877712c26fe425698d898b440f91b44bf.patch $SRC_DIR
ADD patches/8146578592200c7b732bca8ab43be05a84e34269.patch $SRC_DIR
ADD patches/a8ebd69d8a759c06f49102226192174c32fbb15b.patch $SRC_DIR
ADD patches/e24734913d25c0bffdf1cfd79e14ef43d01e1019.patch $SRC_DIR
ADD patches/8f4e4868377afb5e980856755b9f6394f8b649e2.patch $SRC_DIR
ADD patches/23a87cabb76fbdce5092a6b3d3b56f3fa8dd61f5.patch $SRC_DIR
ADD patches/89ca60989df4af9a96cc6024e04f99b9b77bad22.patch $SRC_DIR
ADD patches/aeafa43fc51be8ea1c7abfbe779c69205c1c5aa4.patch $SRC_DIR
ADD patches/71f831b9cc5a6dc923af4ca90286857e2cf8b1d3.patch $SRC_DIR
ADD patches/0f6fe4202001c0950dc689179e7a4ad9554a51fa.patch $SRC_DIR
ADD patches/472809ebc83588cf321935804f171b271fd81476.patch $SRC_DIR
ADD patches/60207f7a3d072848936221f1b767722984fd50ae.patch $SRC_DIR
ADD patches/89eaa68a006f29b2e766062e796d452fee12c3f2.patch $SRC_DIR

RUN apt update && apt install build-essential git libnuma-dev autoconf curl \
    python3 libmnl-dev libpcap-dev libtool libcap-ng-dev libssl-dev pkg-config \
    python3-six libunbound-dev libunwind-dev dh-make fakeroot debhelper dh-python \
    flake8 python3-sphinx graphviz groff wget -y

RUN cd /usr/src/ && \
    git clone -b branch-2.16 --depth=1 https://github.com/openvswitch/ovs.git && \
    cd ovs && \
    # ofproto: Fix re-creation of tunnel backing interfaces on restart.
    git apply $SRC_DIR/8661abd4c41a89116fbd4e4d210e73165cedd323.patch && \
    # fix memleak
    git apply $SRC_DIR/2dc8e7aa202818952b2fa80b47298604530c9de0.patch && \
    # fix log file descriptor leak in monitor process
    git apply $SRC_DIR/918d6dc79634bec760054ee53f7628186315bcfb.patch && \
    # increase election timer
    git apply $SRC_DIR/22ea22c40b46ee5adeae977ff6cfca81b3ff25d7.patch && \
    # add fdb update logging
    git apply $SRC_DIR/8c2f28b778129161bbf8f0738fa41d385860d5bc.patch && \
    # fdb: fix mac learning in environments with hairpin enabled
    git apply $SRC_DIR/1cb138aaf2fdf922d75a587e4e9cf610d38f9fee.patch && \
    # ovsdb-tool: add optional server id parameter for "join-cluster" command
    git apply $SRC_DIR/2e2ec1161cadbec79786d63fde9475053d996586.patch && \
    ./boot.sh && \
    rm -rf .git && \
    CONFIGURE_OPTS='' && \
    if [ "$ARCH" = "amd64" ]; then CONFIGURE_OPTS='CFLAGS="-O2 -g -msse4.2 -mpopcnt"'; fi && \
    DATAPATH_CONFIGURE_OPTS='--prefix=/usr' EXTRA_CONFIGURE_OPTS=$CONFIGURE_OPTS DEB_BUILD_OPTIONS='parallel=8 nocheck' fakeroot debian/rules binary

RUN dpkg -i /usr/src/python3-openvswitch*.deb /usr/src/libopenvswitch*.deb

RUN cd /usr/src/ && git clone -b branch-21.06 --depth=1 https://github.com/ovn-org/ovn.git && \
    cd ovn && \
    # fix ssl listen address
    git apply $SRC_DIR/62d4969877712c26fe425698d898b440f91b44bf.patch && \
    # expr.c: Use expr_destroy and expr_clone instead of free and xmemdup.
    git apply $SRC_DIR/4b4cadcfabbc79f7d69c213be2b37e5e8634201c.patch && \
    # treewide: bump ovs and fix problematic loops
    git apply $SRC_DIR/8146578592200c7b732bca8ab43be05a84e34269.patch && \
    # ovn-controller: Add a generic way to check if the daemon started recently.
    git apply $SRC_DIR/a8ebd69d8a759c06f49102226192174c32fbb15b.patch && \
    # patch.c: Avoid patch interface deletion & recreation during restart.
    git apply $SRC_DIR/e24734913d25c0bffdf1cfd79e14ef43d01e1019.patch && \
    # do not send multicast packets to conntrack
    git apply $SRC_DIR/8f4e4868377afb5e980856755b9f6394f8b649e2.patch && \
    # do not send traffic that not designate to svc to conntrack
    git apply $SRC_DIR/23a87cabb76fbdce5092a6b3d3b56f3fa8dd61f5.patch && \
    # Add EXTRA_CONFIGURE_OPTS for debian build
    git apply $SRC_DIR/89ca60989df4af9a96cc6024e04f99b9b77bad22.patch && \
    # fix ipv6 svc
    git apply $SRC_DIR/aeafa43fc51be8ea1c7abfbe779c69205c1c5aa4.patch && \
    # change hash type from dp_hash to hash with field src_ip
    git apply $SRC_DIR/71f831b9cc5a6dc923af4ca90286857e2cf8b1d3.patch && \
    # fix reaching resubmit limit in underlay
    git apply $SRC_DIR/0f6fe4202001c0950dc689179e7a4ad9554a51fa.patch && \
    # do not remove LB if vips is empty
    git apply $SRC_DIR/472809ebc83588cf321935804f171b271fd81476.patch && \
    # ovn-controller: do not send GARP on localnet for Kube-OVN ports
    git apply $SRC_DIR/60207f7a3d072848936221f1b767722984fd50ae.patch && \
    # backport tos inherit from inner packet
    git apply $SRC_DIR/89eaa68a006f29b2e766062e796d452fee12c3f2.patch && \
    sed -i 's/OVN/ovn/g' debian/changelog && \
    rm -rf .git && \
    ./boot.sh && \
    CONFIGURE_OPTS='' && \
    if [ "$ARCH" = "amd64" ]; then CONFIGURE_OPTS='CFLAGS="-O2 -g -msse4.2 -mpopcnt"'; fi && \
    OVSDIR=/usr/src/ovs EXTRA_CONFIGURE_OPTS=$CONFIGURE_OPTS DEB_BUILD_OPTIONS='parallel=8 nocheck' fakeroot debian/rules binary

RUN mkdir /packages/ && \
     cp /usr/src/libopenvswitch*.deb /packages && \
     cp /usr/src/openvswitch-*.deb /packages && \
     cp /usr/src/python3-openvswitch*.deb /packages && \
     cp /usr/src/ovn-*.deb /packages && \
     cd /packages && rm -f *dbg* *datapath* *docker* *vtep* *ipsec* *test* *dev*

FROM ghcr.io/aquasecurity/trivy:latest AS trivy

ARG ARCH
ARG CNI_PLUGINS_VERSION="v1.6.2"
ARG KUBECTL_VERSION="v1.30.11"
ARG TRIVY_DB_REPOSITORY="public.ecr.aws/aquasecurity/trivy-db:2"

RUN apk --no-cache add curl jq
ADD go-deps/download-go-deps.sh /
RUN sh -x /download-go-deps.sh

FROM golang:$GO_VERSION-alpine AS go-deps

RUN apk --no-cache add bash curl jq
ADD go-deps/rebuild-go-deps.sh /
RUN --mount=type=bind,target=/trivy,from=trivy,source=/godeps \
    bash -x /rebuild-go-deps.sh

FROM ubuntu:22.04

ARG DEBIAN_FRONTEND=noninteractive
RUN apt update && apt upgrade -y && apt install ca-certificates python3 hostname libunwind8 netbase \
        ethtool iproute2 ncat libunbound-dev procps libatomic1 kmod iptables \
        tcpdump ipset curl uuid-runtime openssl inetutils-ping arping ndisc6 traceroute \
        logrotate dnsutils net-tools nmap -y --no-install-recommends && \
        rm -rf /var/lib/apt/lists/* && \
        rm -rf /etc/localtime

RUN mkdir -p /var/run/openvswitch && \
    mkdir -p /var/run/ovn && \
    mkdir -p /etc/cni/net.d && \
    mkdir -p /opt/cni/bin

RUN --mount=type=bind,target=/godeps,from=go-deps,source=/godeps \
    cp /godeps/loopback /godeps/portmap /godeps/macvlan ./ && \
    cp /godeps/kubectl /usr/bin/

RUN --mount=type=bind,target=/packages,from=ovs-builder,source=/packages  \
    dpkg -i /packages/libopenvswitch*.deb && \
    dpkg -i /packages/openvswitch-*.deb && \
    dpkg -i /packages/python3-openvswitch*.deb && \
    dpkg -i --ignore-depends=openvswitch-switch,openvswitch-common /packages/ovn-*.deb && \
    rm -rf /var/lib/openvswitch/pki/
