# syntax = docker/dockerfile:experimental
ARG GO_VERSION=1.22.12

FROM ubuntu:22.04 AS ovs-builder

ARG ARCH
ARG NO_AVX512=false
ARG DEBIAN_FRONTEND=noninteractive
ENV SRC_DIR='/usr/src'

ADD patches/bef703ef862fbbf8740b8d5bf6ca8df9ed617da5.patch $SRC_DIR
ADD patches/3cf5c5236494b5f54dd2c363f2b547f9d90b372d.patch $SRC_DIR
ADD patches/9bce4a9bced0d699ebbb2893bc68448bb0243846.patch $SRC_DIR
ADD patches/28ee0fc71cd4256fc422fff30d13e2aa0028cfca.patch $SRC_DIR
ADD patches/e3ed5ec298e2427b77dd2252e8c2218894e45220.patch $SRC_DIR
ADD patches/b721a251dadfb0857a2aebe32611d18ca935421f.patch $SRC_DIR
ADD patches/0664cbe47d1684ca5b7147e3449779635454970e.patch $SRC_DIR
ADD patches/f52c239f5ded40b503e4d217f916b46ca413da4c.patch $SRC_DIR
ADD patches/6a4dd2f4b9311a227cc26fef7c398ae9b241311b.patch $SRC_DIR
ADD patches/f61283c8934589fe6de2b1e86041204dfc31a3e3.patch $SRC_DIR
ADD patches/dca043b2c35756fd370214fc40d61f755bd3a66f.patch $SRC_DIR
ADD patches/2d6823753c295411ac63a66d1d1c5a5d8ba57bdc.patch $SRC_DIR
ADD patches/03a46942b9e14d77a23313c193fe062ccafa4769.patch $SRC_DIR
ADD patches/168a3f20579b720370f137c82c04cf3b1a9811e2.patch $SRC_DIR
ADD patches/c1d265adc1b148a4c3fb07b9e1b172e1fdf99be4.patch $SRC_DIR
ADD patches/ab0818fed95fa3633f8c52e4afb1f8c19ff5ef1f.patch $SRC_DIR
ADD patches/8b5084a55ca3f68f46530f43310ae2eae74322d2.patch $SRC_DIR
ADD patches/472809ebc83588cf321935804f171b271fd81476.patch $SRC_DIR
ADD patches/1792621bf33a661d66ca47620871668267e3e521.patch $SRC_DIR
ADD patches/f9ad910c8036dc138e52738c400ddcca7236337e.patch $SRC_DIR

RUN apt update && apt install build-essential git libnuma-dev autoconf curl \
    python3 libmnl-dev libpcap-dev libtool libcap-ng-dev libssl-dev pkg-config \
    python3-six libunbound-dev libunwind-dev dh-make fakeroot debhelper dh-python \
    flake8 python3-sphinx graphviz groff wget -y

RUN cd /usr/src/ && \
    git clone -b branch-2.17 --depth=1 https://github.com/openvswitch/ovs.git && \
    cd ovs && \
    # ovsdb-idl: Support write-only-changed IDL monitor mode
    git apply $SRC_DIR/bef703ef862fbbf8740b8d5bf6ca8df9ed617da5.patch && \
    # fix memleak
    git apply $SRC_DIR/3cf5c5236494b5f54dd2c363f2b547f9d90b372d.patch && \
    # fix log file descriptor leak in monitor process
    git apply $SRC_DIR/9bce4a9bced0d699ebbb2893bc68448bb0243846.patch && \
    # increase election timer
    git apply $SRC_DIR/28ee0fc71cd4256fc422fff30d13e2aa0028cfca.patch && \
    # add fdb update logging
    git apply $SRC_DIR/e3ed5ec298e2427b77dd2252e8c2218894e45220.patch && \
    # fdb: fix mac learning in environments with hairpin enabled
    git apply $SRC_DIR/b721a251dadfb0857a2aebe32611d18ca935421f.patch && \
    # ovsdb-tool: add optional server id parameter for "join-cluster" command
    git apply $SRC_DIR/0664cbe47d1684ca5b7147e3449779635454970e.patch && \
    # ovsdb-tool: add command fix-cluster
    git apply $SRC_DIR/f52c239f5ded40b503e4d217f916b46ca413da4c.patch && \
    # fix memory leak in qos
    git apply $SRC_DIR/6a4dd2f4b9311a227cc26fef7c398ae9b241311b.patch && \
    # compile without avx512
    if [ "$ARCH" = "amd64" -a "$NO_AVX512" = "true" ]; then git apply $SRC_DIR/f61283c8934589fe6de2b1e86041204dfc31a3e3.patch; fi && \
    ./boot.sh && \
    rm -rf .git && \
    CONFIGURE_OPTS='' && \
    if [ "$ARCH" = "amd64" ]; then CONFIGURE_OPTS='CFLAGS="-O2 -g -msse4.2 -mpopcnt"'; fi && \
    DATAPATH_CONFIGURE_OPTS='--prefix=/usr' EXTRA_CONFIGURE_OPTS=$CONFIGURE_OPTS DEB_BUILD_OPTIONS='parallel=8 nocheck' fakeroot debian/rules binary

RUN dpkg -i /usr/src/python3-openvswitch*.deb /usr/src/libopenvswitch*.deb

RUN cd /usr/src/ && git clone -b branch-22.03 --depth=1 https://github.com/ovn-org/ovn.git && \
    cd ovn && \
    # fix ssl listen address
    git apply $SRC_DIR/dca043b2c35756fd370214fc40d61f755bd3a66f.patch && \
    # ovn-controller: Add a generic way to check if the daemon started recently.
    git apply $SRC_DIR/2d6823753c295411ac63a66d1d1c5a5d8ba57bdc.patch && \
    # patch.c: Avoid patch interface deletion & recreation during restart.
    git apply $SRC_DIR/03a46942b9e14d77a23313c193fe062ccafa4769.patch && \
    # change hash type from dp_hash to hash with field src_ip
    git apply $SRC_DIR/168a3f20579b720370f137c82c04cf3b1a9811e2.patch && \
    # set ether dst addr for dnat on logical switch
    git apply $SRC_DIR/c1d265adc1b148a4c3fb07b9e1b172e1fdf99be4.patch && \
    # modify src route priority
    git apply $SRC_DIR/ab0818fed95fa3633f8c52e4afb1f8c19ff5ef1f.patch && \
    # fix reaching resubmit limit in underlay
    git apply $SRC_DIR/8b5084a55ca3f68f46530f43310ae2eae74322d2.patch && \
    # do not remove LB if vips is empty
    git apply $SRC_DIR/472809ebc83588cf321935804f171b271fd81476.patch && \
    # ovn-controller: do not send GARP on localnet for Kube-OVN ports
    git apply $SRC_DIR/1792621bf33a661d66ca47620871668267e3e521.patch && \
    # lflow: do not send direct traffic between lports to conntrack
    git apply $SRC_DIR/f9ad910c8036dc138e52738c400ddcca7236337e.patch && \
    sed -i 's/OVN/ovn/g' debian/changelog && \
    rm -rf .git && \
    ./boot.sh && \
    CONFIGURE_OPTS='' && \
    if [ "$ARCH" = "amd64" ]; then CONFIGURE_OPTS='CFLAGS="-O2 -g -msse4.2 -mpopcnt"'; fi && \
    OVSDIR=/usr/src/ovs EXTRA_CONFIGURE_OPTS=$CONFIGURE_OPTS DEB_BUILD_OPTIONS='parallel=8 nocheck' fakeroot debian/rules binary

RUN mkdir /packages/ && \
     cp /usr/src/libopenvswitch*deb /packages && \
     cp /usr/src/openvswitch-*deb /packages && \
     cp /usr/src/python3-openvswitch*deb /packages && \
     cp /usr/src/ovn-*deb /packages && \
     cd /packages && rm -f *datapath* *docker* *vtep* *test* *dev*

FROM ghcr.io/aquasecurity/trivy:latest AS trivy

ARG ARCH
ENV CNI_PLUGINS_VERSION="v1.5.1"
ENV KUBECTL_VERSION="v1.30.10"
ENV TRIVY_DB_REPOSITORY="public.ecr.aws/aquasecurity/trivy-db:2"

RUN apk --no-cache add curl jq
ADD go-deps/download-go-deps.sh /
RUN sh -x /download-go-deps.sh

FROM golang:$GO_VERSION-alpine AS go-deps

RUN apk --no-cache add bash curl jq
ADD go-deps/rebuild-go-deps.sh /
RUN --mount=type=bind,target=/trivy,from=trivy,source=/godeps \
    bash -x /rebuild-go-deps.sh

FROM ubuntu:22.04

ARG DEBIAN_FRONTEND=noninteractive
RUN apt update && apt upgrade -y && apt install ca-certificates python3 hostname libunwind8 netbase \
        ethtool iproute2 ncat libunbound8 procps libatomic1 kmod iptables \
        tcpdump ipset curl uuid-runtime openssl inetutils-ping iputils-tracepath arping ndisc6 traceroute \
        logrotate dnsutils net-tools strongswan strongswan-pki libcharon-extra-plugins \
        libcharon-extauth-plugins libstrongswan-extra-plugins libstrongswan-standard-plugins -y --no-install-recommends && \
        rm -rf /var/lib/apt/lists/* && \
        rm -rf /etc/localtime

RUN mkdir -p /var/run/openvswitch && \
    mkdir -p /var/run/ovn && \
    mkdir -p /etc/cni/net.d && \
    mkdir -p /opt/cni/bin

RUN --mount=type=bind,target=/packages,from=ovs-builder,source=/packages  \
    dpkg -i /packages/libopenvswitch*.deb && \
    dpkg -i /packages/python3-openvswitch*.deb && \
    dpkg -i /packages/openvswitch-*.deb && \
    dpkg -i --ignore-depends=openvswitch-switch,openvswitch-common /packages/ovn-*.deb && \
    mv /usr/lib/python3.7/dist-packages/ovs /usr/lib/python3/dist-packages/ && \
    rm -rf /var/lib/openvswitch/pki/

ARG ARCH
ARG DUMB_INIT_VERSION="1.2.5"
RUN dump_arch="x86_64"; \
    if [ "$ARCH" = "arm64" ]; then dump_arch="aarch64"; fi; \
    curl -sSf -L --retry 5 -o /usr/bin/dumb-init https://github.com/Yelp/dumb-init/releases/download/v${DUMB_INIT_VERSION}/dumb-init_${DUMB_INIT_VERSION}_${dump_arch} && \
    chmod +x /usr/bin/dumb-init

RUN --mount=type=bind,target=/godeps,from=go-deps,source=/godeps \
    cp /godeps/loopback /godeps/portmap /godeps/macvlan ./ && \
    cp /godeps/kubectl /usr/bin/

RUN --mount=type=bind,target=/packages,from=ovs-builder,source=/packages  \
    dpkg -i /packages/openvswitch-*.deb /packages/python3-openvswitch*.deb && \
    dpkg -i --ignore-depends=openvswitch-switch,openvswitch-common /packages/ovn-*.deb && \
    rm -rf /var/lib/openvswitch/pki/

ARG DEBUG=false
RUN --mount=type=bind,target=/packages,from=ovs-builder,source=/packages \
    if [ "${DEBUG}" = "true" ]; then \
        apt update && apt install -y --no-install-recommends gdb valgrind && \
        rm -rf /var/lib/apt/lists/* && \
        dpkg -i --ignore-depends=openvswitch-switch,openvswitch-common /packages/*.ddeb; \
    fi

ENTRYPOINT ["/usr/bin/dumb-init", "--"]
