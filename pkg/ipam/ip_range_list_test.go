package ipam

import (
	"testing"

	"github.com/stretchr/testify/require"
)

func TestNewIPRangeList(t *testing.T) {
	// test ipv4 contains
	v4RangeStart1, err := NewIP("10.0.0.5")
	require.NoError(t, err)
	v4RangeEnd1, err := NewIP("10.0.0.5")
	require.NoError(t, err)
	v4RangeStart2, err := NewIP("10.0.0.13")
	require.NoError(t, err)
	v4RangeEnd2, err := NewIP("10.0.0.18")
	require.NoError(t, err)

	v4, err := NewIPRangeList(v4RangeStart1, v4RangeEnd1, v4RangeStart2, v4RangeEnd2)
	require.NoError(t, err)

	fakeV4RangeItem1, err := NewIP("10.0.0.4")
	require.NoError(t, err)
	require.False(t, v4.Contains(fakeV4RangeItem1))
	require.True(t, v4.Contains(v4RangeStart1))
	fakeV4RangeItem2, err := NewIP("10.0.0.6")
	require.NoError(t, err)
	require.False(t, v4.Contains(fakeV4RangeItem2))
	fakeV4RangeItem3, err := NewIP("10.0.0.12")
	require.NoError(t, err)
	require.False(t, v4.Contains(fakeV4RangeItem3))
	require.True(t, v4.Contains(v4RangeStart2))
	realV4RangeItem1, err := NewIP("10.0.0.14")
	require.NoError(t, err)
	require.True(t, v4.Contains(realV4RangeItem1))
	realV4RangeItem2, err := NewIP("10.0.0.17")
	require.NoError(t, err)
	require.True(t, v4.Contains(realV4RangeItem2))
	realV4RangeItem3, err := NewIP("10.0.0.18")
	require.NoError(t, err)
	require.True(t, v4.Contains(realV4RangeItem3))
	fakeV4RangeItem4, err := NewIP("10.0.0.19")
	require.NoError(t, err)
	require.False(t, v4.Contains(fakeV4RangeItem4))
	// test ipv6 contains
	v6RangeStart1, err := NewIP("2001:db8::5")
	require.NoError(t, err)
	v6RangeEnd1, err := NewIP("2001:db8::5")
	require.NoError(t, err)
	v6RangeStart2, err := NewIP("2001:db8::13")
	require.NoError(t, err)
	v6RangeEnd2, err := NewIP("2001:db8::18")
	require.NoError(t, err)
	v6, err := NewIPRangeList(v6RangeStart1, v6RangeEnd1, v6RangeStart2, v6RangeEnd2)
	require.NoError(t, err)
	fakeV6RangeItem1, err := NewIP("2001:db8::4")
	require.NoError(t, err)
	require.False(t, v6.Contains(fakeV6RangeItem1))
	require.True(t, v6.Contains(v6RangeStart1))
	fakeV6RangeItem2, err := NewIP("2001:db8::6")
	require.NoError(t, err)
	require.False(t, v6.Contains(fakeV6RangeItem2))
	fakeV6RangeItem3, err := NewIP("2001:db8::12")
	require.NoError(t, err)
	require.False(t, v6.Contains(fakeV6RangeItem3))
	require.True(t, v6.Contains(v6RangeStart2))
	realV6RangeItem1, err := NewIP("2001:db8::14")
	require.NoError(t, err)
	require.True(t, v6.Contains(realV6RangeItem1))
	realV6RangeItem2, err := NewIP("2001:db8::17")
	require.NoError(t, err)
	require.True(t, v6.Contains(realV6RangeItem2))
	realV6RangeItem3, err := NewIP("2001:db8::18")
	require.NoError(t, err)
	require.True(t, v6.Contains(realV6RangeItem3))
	fakeV6RangeItem4, err := NewIP("2001:db8::19")
	require.NoError(t, err)
	require.False(t, v6.Contains(fakeV6RangeItem4))
	// test ipv4 add
	v4RangeStart1, err = NewIP("10.0.0.5")
	require.NoError(t, err)
	v4RangeEnd1, err = NewIP("10.0.0.5")
	require.NoError(t, err)
	v4RangeStart2, err = NewIP("10.0.0.13")
	require.NoError(t, err)
	v4RangeEnd2, err = NewIP("10.0.0.18")
	require.NoError(t, err)
	v4, err = NewIPRangeList(v4RangeStart1, v4RangeEnd1, v4RangeStart2, v4RangeEnd2)
	require.NoError(t, err)
	v4AddIP1, err := NewIP("10.0.0.4")
	require.NoError(t, err)
	require.True(t, v4.Add(v4AddIP1))
	v4AddIP2, err := NewIP("10.0.0.5")
	require.NoError(t, err)
	require.False(t, v4.Add(v4AddIP2))
	v4AddIP3, err := NewIP("10.0.0.6")
	require.NoError(t, err)
	require.True(t, v4.Add(v4AddIP3))

	v4AddIP4, err := NewIP("10.0.0.12")
	require.NoError(t, err)
	require.True(t, v4.Add(v4AddIP4))
	v4AddIP5, err := NewIP("10.0.0.13")
	require.NoError(t, err)
	require.False(t, v4.Add(v4AddIP5))
	v4AddIP6, err := NewIP("10.0.0.14")
	require.NoError(t, err)
	require.False(t, v4.Add(v4AddIP6))
	v4AddIP7, err := NewIP("10.0.0.17")
	require.NoError(t, err)
	require.False(t, v4.Add(v4AddIP7))
	v4AddIP8, err := NewIP("10.0.0.18")
	require.NoError(t, err)
	require.False(t, v4.Add(v4AddIP8))
	v4AddIP9, err := NewIP("10.0.0.19")
	require.NoError(t, err)
	require.True(t, v4.Add(v4AddIP9))

	v4AddExpectRangeStart1, err := NewIP("10.0.0.4")
	require.NoError(t, err)
	v4AddExpectRangeEnd1, err := NewIP("10.0.0.6")
	require.NoError(t, err)
	v4AddExpectRangeStart2, err := NewIP("10.0.0.12")
	require.NoError(t, err)
	v4AddExpectRangeEnd2, err := NewIP("10.0.0.19")
	require.NoError(t, err)
	v4AddExpect, err := NewIPRangeList(v4AddExpectRangeStart1, v4AddExpectRangeEnd1, v4AddExpectRangeStart2, v4AddExpectRangeEnd2)
	require.NoError(t, err)

	require.True(t, v4.Equal(v4AddExpect))
	// test ipv6 add
	v6RangeStart1, err = NewIP("2001:db8::5")
	require.NoError(t, err)
	v6RangeEnd1, err = NewIP("2001:db8::5")
	require.NoError(t, err)
	v6RangeStart2, err = NewIP("2001:db8::13")
	require.NoError(t, err)
	v6RangeEnd2, err = NewIP("2001:db8::18")
	require.NoError(t, err)
	v6, err = NewIPRangeList(v6RangeStart1, v6RangeEnd1, v6RangeStart2, v6RangeEnd2)
	require.NoError(t, err)
	v6AddIP1, err := NewIP("2001:db8::4")
	require.NoError(t, err)
	require.True(t, v6.Add(v6AddIP1))
	v6AddIP2, err := NewIP("2001:db8::5")
	require.NoError(t, err)
	require.False(t, v6.Add(v6AddIP2))
	v6AddIP3, err := NewIP("2001:db8::6")
	require.NoError(t, err)
	require.True(t, v6.Add(v6AddIP3))

	v6AddIP4, err := NewIP("2001:db8::12")
	require.NoError(t, err)
	require.True(t, v6.Add(v6AddIP4))
	v6AddIP5, err := NewIP("2001:db8::13")
	require.NoError(t, err)
	require.False(t, v6.Add(v6AddIP5))
	v6AddIP6, err := NewIP("2001:db8::14")
	require.NoError(t, err)
	require.False(t, v6.Add(v6AddIP6))
	v6AddIP7, err := NewIP("2001:db8::17")
	require.NoError(t, err)
	require.False(t, v6.Add(v6AddIP7))
	v6AddIP8, err := NewIP("2001:db8::18")
	require.NoError(t, err)
	require.False(t, v6.Add(v6AddIP8))
	v6AddIP9, err := NewIP("2001:db8::19")
	require.NoError(t, err)
	require.True(t, v6.Add(v6AddIP9))
	v6AddExpectRangeStart1, err := NewIP("2001:db8::4")
	require.NoError(t, err)
	v6AddExpectRangeEnd1, err := NewIP("2001:db8::6")
	require.NoError(t, err)
	v6AddExpectRangeStart2, err := NewIP("2001:db8::12")
	require.NoError(t, err)
	v6AddExpectRangeEnd2, err := NewIP("2001:db8::19")
	require.NoError(t, err)
	v6AddExpect, err := NewIPRangeList(v6AddExpectRangeStart1, v6AddExpectRangeEnd1, v6AddExpectRangeStart2, v6AddExpectRangeEnd2)
	require.NoError(t, err)

	require.True(t, v6.Equal(v6AddExpect))
	// test ipv4 remove
	v4RangeStart1, err = NewIP("10.0.0.5")
	require.NoError(t, err)
	v4RangeEnd1, err = NewIP("10.0.0.5")
	require.NoError(t, err)
	v4RangeStart2, err = NewIP("10.0.0.13")
	require.NoError(t, err)
	v4RangeEnd2, err = NewIP("10.0.0.18")
	require.NoError(t, err)
	v4, err = NewIPRangeList(v4RangeStart1, v4RangeEnd1, v4RangeStart2, v4RangeEnd2)
	require.NoError(t, err)
	v4RemoveIP1, err := NewIP("10.0.0.4")
	require.NoError(t, err)
	require.False(t, v4.Remove(v4RemoveIP1))
	v4RemoveIP2, err := NewIP("10.0.0.5")
	require.NoError(t, err)
	require.True(t, v4.Remove(v4RemoveIP2))
	v4RemoveIP3, err := NewIP("10.0.0.6")
	require.NoError(t, err)
	require.False(t, v4.Remove(v4RemoveIP3))

	v4RemoveIP4, err := NewIP("10.0.0.12")
	require.NoError(t, err)
	require.False(t, v4.Remove(v4RemoveIP4))
	v4RemoveIP5, err := NewIP("10.0.0.13")
	require.NoError(t, err)
	require.True(t, v4.Remove(v4RemoveIP5))
	v4RemoveIP6, err := NewIP("10.0.0.14")
	require.NoError(t, err)
	require.True(t, v4.Remove(v4RemoveIP6))
	v4RemoveIP7, err := NewIP("10.0.0.17")
	require.NoError(t, err)
	require.True(t, v4.Remove(v4RemoveIP7))
	v4RemoveIP8, err := NewIP("10.0.0.18")
	require.NoError(t, err)
	require.True(t, v4.Remove(v4RemoveIP8))
	v4RemoveIP9, err := NewIP("10.0.0.19")
	require.NoError(t, err)
	require.False(t, v4.Remove(v4RemoveIP9))
	v4RemoveExpectRangeStart1, err := NewIP("10.0.0.15")
	require.NoError(t, err)
	v4RemoveExpectRangeEnd1, err := NewIP("10.0.0.16")
	require.NoError(t, err)
	v4RemoveExpect, err := NewIPRangeList(v4RemoveExpectRangeStart1, v4RemoveExpectRangeEnd1)
	require.NoError(t, err)

	require.True(t, v4.Equal(v4RemoveExpect))
	// split the range
	v4RangeStart1, err = NewIP("10.0.0.10")
	require.NoError(t, err)
	v4RangeEnd1, err = NewIP("10.0.0.20")
	require.NoError(t, err)
	v4, err = NewIPRangeList(v4RangeStart1, v4RangeEnd1)
	require.NoError(t, err)
	v4RemoveIP1, err = NewIP("10.0.0.15")
	require.NoError(t, err)
	require.True(t, v4.Remove(v4RemoveIP1))
	v4SplitedExpectRangeStart1, err := NewIP("10.0.0.10")
	require.NoError(t, err)
	v4SplitedExpectRangeEnd1, err := NewIP("10.0.0.14")
	require.NoError(t, err)
	v4SplitedExpectRangeStart2, err := NewIP("10.0.0.16")
	require.NoError(t, err)
	v4SplitedExpectRangeEnd2, err := NewIP("10.0.0.20")
	require.NoError(t, err)
	v4SplitedExpect, err := NewIPRangeList(v4SplitedExpectRangeStart1, v4SplitedExpectRangeEnd1, v4SplitedExpectRangeStart2, v4SplitedExpectRangeEnd2)
	require.NoError(t, err)
	require.True(t, v4.Equal(v4SplitedExpect))

	// test ipv6 remove
	v6RangeStart1, err = NewIP("2001:db8::5")
	require.NoError(t, err)
	v6RangeEnd1, err = NewIP("2001:db8::5")
	require.NoError(t, err)
	v6RangeStart2, err = NewIP("2001:db8::13")
	require.NoError(t, err)
	v6RangeEnd2, err = NewIP("2001:db8::18")
	require.NoError(t, err)
	v6, err = NewIPRangeList(v6RangeStart1, v6RangeEnd1, v6RangeStart2, v6RangeEnd2)
	require.NoError(t, err)
	v6RemoveIP1, err := NewIP("2001:db8::4")
	require.NoError(t, err)
	require.False(t, v6.Remove(v6RemoveIP1))
	v6RemoveIP2, err := NewIP("2001:db8::5")
	require.NoError(t, err)
	require.True(t, v6.Remove(v6RemoveIP2))
	v6RemoveIP3, err := NewIP("2001:db8::6")
	require.NoError(t, err)
	require.False(t, v6.Remove(v6RemoveIP3))

	v6RemoveIP4, err := NewIP("2001:db8::12")
	require.NoError(t, err)
	require.False(t, v6.Remove(v6RemoveIP4))
	v6RemoveIP5, err := NewIP("2001:db8::13")
	require.NoError(t, err)
	require.True(t, v6.Remove(v6RemoveIP5))
	v6RemoveIP6, err := NewIP("2001:db8::14")
	require.NoError(t, err)
	require.True(t, v6.Remove(v6RemoveIP6))
	v6RemoveIP7, err := NewIP("2001:db8::17")
	require.NoError(t, err)
	require.True(t, v6.Remove(v6RemoveIP7))
	v6RemoveIP8, err := NewIP("2001:db8::18")
	require.NoError(t, err)
	require.True(t, v6.Remove(v6RemoveIP8))
	v6RemoveIP9, err := NewIP("2001:db8::19")
	require.NoError(t, err)
	require.False(t, v6.Remove(v6RemoveIP9))

	v6RemoveExpectRangeStart1, err := NewIP("2001:db8::15")
	require.NoError(t, err)
	v6RemoveExpectRangeEnd1, err := NewIP("2001:db8::16")
	require.NoError(t, err)
	v6RemoveExpect, err := NewIPRangeList(v6RemoveExpectRangeStart1, v6RemoveExpectRangeEnd1)
	require.NoError(t, err)

	require.True(t, v6.Equal(v6RemoveExpect))
	// split the range
	v6RangeStart1, err = NewIP("2001:db8::10")
	require.NoError(t, err)
	v6RangeEnd1, err = NewIP("2001:db8::20")
	require.NoError(t, err)
	v6, err = NewIPRangeList(v6RangeStart1, v6RangeEnd1)
	require.NoError(t, err)
	v6RemoveIP1, err = NewIP("2001:db8::15")
	require.NoError(t, err)
	require.True(t, v6.Remove(v6RemoveIP1))
	v6SplitedExpectRangeStart1, err := NewIP("2001:db8::10")
	require.NoError(t, err)
	v6SplitedExpectRangeEnd1, err := NewIP("2001:db8::14")
	require.NoError(t, err)
	v6SplitedExpectRangeStart2, err := NewIP("2001:db8::16")
	require.NoError(t, err)
	v6SplitedExpectRangeEnd2, err := NewIP("2001:db8::20")
	require.NoError(t, err)
	v6SplitedExpect, err := NewIPRangeList(v6SplitedExpectRangeStart1, v6SplitedExpectRangeEnd1, v6SplitedExpectRangeStart2, v6SplitedExpectRangeEnd2)
	require.NoError(t, err)
	require.True(t, v6.Equal(v6SplitedExpect))

	// test ipv4 separate
	v41RangeStart1, err := NewIP("10.0.0.1")
	require.NoError(t, err)
	v41RangeEnd1, err := NewIP("10.0.0.1")
	require.NoError(t, err)
	v41RangeStart2, err := NewIP("10.0.0.5")
	require.NoError(t, err)
	v41RangeEnd2, err := NewIP("10.0.0.5")
	require.NoError(t, err)
	v41RangeStart3, err := NewIP("10.0.0.13")
	require.NoError(t, err)
	v41RangeEnd3, err := NewIP("10.0.0.18")
	require.NoError(t, err)
	v41RangeStart4, err := NewIP("10.0.0.23")
	require.NoError(t, err)
	v41RangeEnd4, err := NewIP("10.0.0.28")
	require.NoError(t, err)
	v41RangeStart5, err := NewIP("10.0.0.33")
	require.NoError(t, err)
	v41RangeEnd5, err := NewIP("10.0.0.38")
	require.NoError(t, err)
	v41RangeStart6, err := NewIP("10.0.0.43")
	require.NoError(t, err)
	v41RangeEnd6, err := NewIP("10.0.0.48")
	require.NoError(t, err)
	v41RangeStart7, err := NewIP("10.0.0.53")
	require.NoError(t, err)
	v41RangeEnd7, err := NewIP("10.0.0.58")
	require.NoError(t, err)
	v41RangeStart8, err := NewIP("10.0.0.63")
	require.NoError(t, err)
	v41RangeEnd8, err := NewIP("10.0.0.68")
	require.NoError(t, err)
	v41, err := NewIPRangeList(
		v41RangeStart1, v41RangeEnd1, v41RangeStart2, v41RangeEnd2,
		v41RangeStart3, v41RangeEnd3, v41RangeStart4, v41RangeEnd4,
		v41RangeStart5, v41RangeEnd5, v41RangeStart6, v41RangeEnd6,
		v41RangeStart7, v41RangeEnd7, v41RangeStart8, v41RangeEnd8)
	require.NoError(t, err)

	v42RangeStart1, err := NewIP("10.0.0.1")
	require.NoError(t, err)
	v42RangeEnd1, err := NewIP("10.0.0.1")
	require.NoError(t, err)
	v42RangeStart2, err := NewIP("10.0.0.11")
	require.NoError(t, err)
	v42RangeEnd2, err := NewIP("10.0.0.15")
	require.NoError(t, err)
	v42RangeStart3, err := NewIP("10.0.0.17")
	require.NoError(t, err)
	v42RangeEnd3, err := NewIP("10.0.0.19")
	require.NoError(t, err)
	v42RangeStart4, err := NewIP("10.0.0.23")
	require.NoError(t, err)
	v42RangeEnd4, err := NewIP("10.0.0.25")
	require.NoError(t, err)
	v42RangeStart5, err := NewIP("10.0.0.27")
	require.NoError(t, err)
	v42RangeEnd5, err := NewIP("10.0.0.28")
	require.NoError(t, err)
	v42RangeStart6, err := NewIP("10.0.0.33")
	require.NoError(t, err)
	v42RangeEnd6, err := NewIP("10.0.0.38")
	require.NoError(t, err)
	v42RangeStart7, err := NewIP("10.0.0.42")
	require.NoError(t, err)
	v42RangeEnd7, err := NewIP("10.0.0.49")
	require.NoError(t, err)
	v42RangeStart8, err := NewIP("10.0.0.53")
	require.NoError(t, err)
	v42RangeEnd8, err := NewIP("10.0.0.58")
	require.NoError(t, err)

	v42, err := NewIPRangeList(
		v42RangeStart1, v42RangeEnd1, v42RangeStart2, v42RangeEnd2,
		v42RangeStart3, v42RangeEnd3, v42RangeStart4, v42RangeEnd4,
		v42RangeStart5, v42RangeEnd5, v42RangeStart6, v42RangeEnd6,
		v42RangeStart7, v42RangeEnd7, v42RangeStart8, v42RangeEnd8)
	require.NoError(t, err)

	v43RangeStart1, err := NewIP("10.0.0.5")
	require.NoError(t, err)
	v43RangeEnd1, err := NewIP("10.0.0.5")
	require.NoError(t, err)
	v43RangeStart2, err := NewIP("10.0.0.16")
	require.NoError(t, err)
	v43RangeEnd2, err := NewIP("10.0.0.16")
	require.NoError(t, err)
	v43RangeStart3, err := NewIP("10.0.0.26")
	require.NoError(t, err)
	v43RangeEnd3, err := NewIP("10.0.0.26")
	require.NoError(t, err)
	v43RangeStart4, err := NewIP("10.0.0.63")
	require.NoError(t, err)
	v43RangeEnd4, err := NewIP("10.0.0.68")
	require.NoError(t, err)

	expected, err := NewIPRangeList(v43RangeStart1, v43RangeEnd1, v43RangeStart2, v43RangeEnd2,
		v43RangeStart3, v43RangeEnd3, v43RangeStart4, v43RangeEnd4)
	require.NoError(t, err)
	separated := v41.Separate(v42)
	require.True(t, separated.Equal(expected))

	// test ipv6 separate
	v61RangeStart1, err := NewIP("2001:db8::1")
	require.NoError(t, err)
	v61RangeEnd1, err := NewIP("2001:db8::1")
	require.NoError(t, err)
	v61RangeStart2, err := NewIP("2001:db8::5")
	require.NoError(t, err)
	v61RangeEnd2, err := NewIP("2001:db8::5")
	require.NoError(t, err)
	v61RangeStart3, err := NewIP("2001:db8::13")
	require.NoError(t, err)
	v61RangeEnd3, err := NewIP("2001:db8::18")
	require.NoError(t, err)
	v61RangeStart4, err := NewIP("2001:db8::23")
	require.NoError(t, err)
	v61RangeEnd4, err := NewIP("2001:db8::28")
	require.NoError(t, err)
	v61RangeStart5, err := NewIP("2001:db8::33")
	require.NoError(t, err)
	v61RangeEnd5, err := NewIP("2001:db8::38")
	require.NoError(t, err)
	v61RangeStart6, err := NewIP("2001:db8::43")
	require.NoError(t, err)
	v61RangeEnd6, err := NewIP("2001:db8::48")
	require.NoError(t, err)
	v61RangeStart7, err := NewIP("2001:db8::53")
	require.NoError(t, err)
	v61RangeEnd7, err := NewIP("2001:db8::58")
	require.NoError(t, err)
	v61RangeStart8, err := NewIP("2001:db8::63")
	require.NoError(t, err)
	v61RangeEnd8, err := NewIP("2001:db8::68")
	require.NoError(t, err)
	v61, err := NewIPRangeList(
		v61RangeStart1, v61RangeEnd1, v61RangeStart2, v61RangeEnd2,
		v61RangeStart3, v61RangeEnd3, v61RangeStart4, v61RangeEnd4,
		v61RangeStart5, v61RangeEnd5, v61RangeStart6, v61RangeEnd6,
		v61RangeStart7, v61RangeEnd7, v61RangeStart8, v61RangeEnd8)
	require.NoError(t, err)
	v62RangeStart1, err := NewIP("2001:db8::1")
	require.NoError(t, err)
	v62RangeEnd1, err := NewIP("2001:db8::1")
	require.NoError(t, err)
	v62RangeStart2, err := NewIP("2001:db8::11")
	require.NoError(t, err)
	v62RangeEnd2, err := NewIP("2001:db8::15")
	require.NoError(t, err)
	v62RangeStart3, err := NewIP("2001:db8::17")
	require.NoError(t, err)
	v62RangeEnd3, err := NewIP("2001:db8::19")
	require.NoError(t, err)
	v62RangeStart4, err := NewIP("2001:db8::23")
	require.NoError(t, err)
	v62RangeEnd4, err := NewIP("2001:db8::25")
	require.NoError(t, err)
	v62RangeStart5, err := NewIP("2001:db8::27")
	require.NoError(t, err)
	v62RangeEnd5, err := NewIP("2001:db8::28")
	require.NoError(t, err)
	v62RangeStart6, err := NewIP("2001:db8::33")
	require.NoError(t, err)
	v62RangeEnd6, err := NewIP("2001:db8::38")
	require.NoError(t, err)
	v62RangeStart7, err := NewIP("2001:db8::42")
	require.NoError(t, err)
	v62RangeEnd7, err := NewIP("2001:db8::49")
	require.NoError(t, err)
	v62RangeStart8, err := NewIP("2001:db8::53")
	require.NoError(t, err)
	v62RangeEnd8, err := NewIP("2001:db8::58")
	require.NoError(t, err)

	v62, err := NewIPRangeList(
		v62RangeStart1, v62RangeEnd1, v62RangeStart2, v62RangeEnd2,
		v62RangeStart3, v62RangeEnd3, v62RangeStart4, v62RangeEnd4,
		v62RangeStart5, v62RangeEnd5, v62RangeStart6, v62RangeEnd6,
		v62RangeStart7, v62RangeEnd7, v62RangeStart8, v62RangeEnd8)
	require.NoError(t, err)

	v63RangeStart1, err := NewIP("2001:db8::5")
	require.NoError(t, err)
	v63RangeEnd1, err := NewIP("2001:db8::5")
	require.NoError(t, err)
	v63RangeStart2, err := NewIP("2001:db8::16")
	require.NoError(t, err)
	v63RangeEnd2, err := NewIP("2001:db8::16")
	require.NoError(t, err)
	v63RangeStart3, err := NewIP("2001:db8::26")
	require.NoError(t, err)
	v63RangeEnd3, err := NewIP("2001:db8::26")
	require.NoError(t, err)
	v63RangeStart4, err := NewIP("2001:db8::63")
	require.NoError(t, err)
	v63RangeEnd4, err := NewIP("2001:db8::68")
	require.NoError(t, err)
	expected, err = NewIPRangeList(
		v63RangeStart1, v63RangeEnd1, v63RangeStart2, v63RangeEnd2,
		v63RangeStart3, v63RangeEnd3, v63RangeStart4, v63RangeEnd4)
	require.NoError(t, err)
	separated = v61.Separate(v62)
	require.True(t, separated.Equal(expected))

	// test ipv4 merge
	v41RangeStart1, err = NewIP("10.0.0.1")
	require.NoError(t, err)
	v41RangeEnd1, err = NewIP("10.0.0.1")
	require.NoError(t, err)
	v41RangeStart2, err = NewIP("10.0.0.3")
	require.NoError(t, err)
	v41RangeEnd2, err = NewIP("10.0.0.3")
	require.NoError(t, err)
	v41RangeStart3, err = NewIP("10.0.0.5")
	require.NoError(t, err)
	v41RangeEnd3, err = NewIP("10.0.0.5")
	require.NoError(t, err)
	v41RangeStart4, err = NewIP("10.0.0.13")
	require.NoError(t, err)
	v41RangeEnd4, err = NewIP("10.0.0.18")
	require.NoError(t, err)
	v41RangeStart5, err = NewIP("10.0.0.23")
	require.NoError(t, err)
	v41RangeEnd5, err = NewIP("10.0.0.28")
	require.NoError(t, err)
	v41RangeStart6, err = NewIP("10.0.0.33")
	require.NoError(t, err)
	v41RangeEnd6, err = NewIP("10.0.0.38")
	require.NoError(t, err)
	v41RangeStart7, err = NewIP("10.0.0.43")
	require.NoError(t, err)
	v41RangeEnd7, err = NewIP("10.0.0.48")
	require.NoError(t, err)
	v41RangeStart8, err = NewIP("10.0.0.53")
	require.NoError(t, err)
	v41RangeEnd8, err = NewIP("10.0.0.58")
	require.NoError(t, err)
	v41RangeStart9, err := NewIP("10.0.0.63")
	require.NoError(t, err)
	v41RangeEnd9, err := NewIP("10.0.0.68")
	require.NoError(t, err)
	v41RangeStart10, err := NewIP("10.0.0.73")
	require.NoError(t, err)
	v41RangeEnd10, err := NewIP("10.0.0.78")
	require.NoError(t, err)
	v41RangeStart11, err := NewIP("10.0.0.83")
	require.NoError(t, err)
	v41RangeEnd11, err := NewIP("10.0.0.88")
	require.NoError(t, err)
	v41RangeStart12, err := NewIP("10.0.0.93")
	require.NoError(t, err)
	v41RangeEnd12, err := NewIP("10.0.0.95")
	require.NoError(t, err)

	v41, err = NewIPRangeList(
		v41RangeStart1, v41RangeEnd1, v41RangeStart2, v41RangeEnd2,
		v41RangeStart3, v41RangeEnd3, v41RangeStart4, v41RangeEnd4,
		v41RangeStart5, v41RangeEnd5, v41RangeStart6, v41RangeEnd6,
		v41RangeStart7, v41RangeEnd7, v41RangeStart8, v41RangeEnd8,
		v41RangeStart9, v41RangeEnd9, v41RangeStart10, v41RangeEnd10,
		v41RangeStart11, v41RangeEnd11, v41RangeStart12, v41RangeEnd12)
	require.NoError(t, err)

	v42RangeStart1, err = NewIP("10.0.0.1")
	require.NoError(t, err)
	v42RangeEnd1, err = NewIP("10.0.0.1")
	require.NoError(t, err)
	v42RangeStart2, err = NewIP("10.0.0.4")
	require.NoError(t, err)
	v42RangeEnd2, err = NewIP("10.0.0.4")
	require.NoError(t, err)
	v42RangeStart3, err = NewIP("10.0.0.11")
	require.NoError(t, err)
	v42RangeEnd3, err = NewIP("10.0.0.15")
	require.NoError(t, err)
	v42RangeStart4, err = NewIP("10.0.0.17")
	require.NoError(t, err)
	v42RangeEnd4, err = NewIP("10.0.0.19")
	require.NoError(t, err)
	v42RangeStart5, err = NewIP("10.0.0.23")
	require.NoError(t, err)
	v42RangeEnd5, err = NewIP("10.0.0.25")
	require.NoError(t, err)
	v42RangeStart6, err = NewIP("10.0.0.27")
	require.NoError(t, err)
	v42RangeEnd6, err = NewIP("10.0.0.28")
	require.NoError(t, err)
	v42RangeStart7, err = NewIP("10.0.0.33")
	require.NoError(t, err)
	v42RangeEnd7, err = NewIP("10.0.0.38")
	require.NoError(t, err)
	v42RangeStart8, err = NewIP("10.0.0.42")
	require.NoError(t, err)
	v42RangeEnd8, err = NewIP("10.0.0.49")
	require.NoError(t, err)
	v42RangeStart9, err := NewIP("10.0.0.53")
	require.NoError(t, err)
	v42RangeEnd9, err := NewIP("10.0.0.58")
	require.NoError(t, err)
	v42RangeStart10, err := NewIP("10.0.0.75")
	require.NoError(t, err)
	v42RangeEnd10, err := NewIP("10.0.0.85")
	require.NoError(t, err)
	v42RangeStart11, err := NewIP("10.0.0.96")
	require.NoError(t, err)
	v42RangeEnd11, err := NewIP("10.0.0.98")
	require.NoError(t, err)

	v42, err = NewIPRangeList(
		v42RangeStart1, v42RangeEnd1, v42RangeStart2, v42RangeEnd2,
		v42RangeStart3, v42RangeEnd3, v42RangeStart4, v42RangeEnd4,
		v42RangeStart5, v42RangeEnd5, v42RangeStart6, v42RangeEnd6,
		v42RangeStart7, v42RangeEnd7, v42RangeStart8, v42RangeEnd8,
		v42RangeStart9, v42RangeEnd9, v42RangeStart10, v42RangeEnd10,
		v42RangeStart11, v42RangeEnd11)
	require.NoError(t, err)

	v43RangeStart1, err = NewIP("10.0.0.1")
	require.NoError(t, err)
	v43RangeEnd1, err = NewIP("10.0.0.1")
	require.NoError(t, err)
	v43RangeStart2, err = NewIP("10.0.0.3")
	require.NoError(t, err)
	v43RangeEnd2, err = NewIP("10.0.0.5")
	require.NoError(t, err)
	v43RangeStart3, err = NewIP("10.0.0.11")
	require.NoError(t, err)
	v43RangeEnd3, err = NewIP("10.0.0.19")
	require.NoError(t, err)
	v43RangeStart4, err = NewIP("10.0.0.23")
	require.NoError(t, err)
	v43RangeEnd4, err = NewIP("10.0.0.28")
	require.NoError(t, err)
	v43RangeStart5, err := NewIP("10.0.0.33")
	require.NoError(t, err)
	v43RangeEnd5, err := NewIP("10.0.0.38")
	require.NoError(t, err)
	v43RangeStart6, err := NewIP("10.0.0.42")
	require.NoError(t, err)
	v43RangeEnd6, err := NewIP("10.0.0.49")
	require.NoError(t, err)
	v43RangeStart7, err := NewIP("10.0.0.53")
	require.NoError(t, err)
	v43RangeEnd7, err := NewIP("10.0.0.58")
	require.NoError(t, err)
	v43RangeStart8, err := NewIP("10.0.0.63")
	require.NoError(t, err)
	v43RangeEnd8, err := NewIP("10.0.0.68")
	require.NoError(t, err)
	v43RangeStart9, err := NewIP("10.0.0.73")
	require.NoError(t, err)
	v43RangeEnd9, err := NewIP("10.0.0.88")
	require.NoError(t, err)
	v43RangeStart10, err := NewIP("10.0.0.93")
	require.NoError(t, err)
	v43RangeEnd10, err := NewIP("10.0.0.98")
	require.NoError(t, err)

	expected, err = NewIPRangeList(v43RangeStart1, v43RangeEnd1, v43RangeStart2, v43RangeEnd2,
		v43RangeStart3, v43RangeEnd3, v43RangeStart4, v43RangeEnd4,
		v43RangeStart5, v43RangeEnd5, v43RangeStart6, v43RangeEnd6,
		v43RangeStart7, v43RangeEnd7, v43RangeStart8, v43RangeEnd8,
		v43RangeStart9, v43RangeEnd9, v43RangeStart10, v43RangeEnd10)

	require.NoError(t, err)
	merged := v41.Merge(v42)
	require.True(t, merged.Equal(expected))
}
